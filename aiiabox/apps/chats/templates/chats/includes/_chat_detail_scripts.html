{% comment %}
Chat Detail Scripts

Alpine.js component for chat detail view interactivity.
{% endcomment %}

<script>
  function chatDetail() {
    return {
      chatId: window.location.pathname.split('/')[2],

      init() {
        this.scrollToBottom();
        this.observeMessages();
      },

      scrollToBottom() {
        const container = document.getElementById('messages-container');
        if (container) {
          setTimeout(() => {
            container.scrollTop = container.scrollHeight;
          }, 0);
        }
      },

      observeMessages() {
        const container = document.getElementById('messages-container');
        if (container) {
          const observer = new MutationObserver(() => {
            this.scrollToBottom();
          });

          observer.observe(container, { childList: true, subtree: true });
        }
      },

      handleScroll() {
        // Placeholder for future scroll detection logic
      },

      async renameChat(event) {
        const form = event.target;
        const newTitle = form.querySelector('input[name="title"]').value.trim();

        if (!newTitle) {
          alert('Chat title cannot be empty.');
          return;
        }

        try {
          const response = await fetch(`/api/chats/${this.chatId}/`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
            },
            body: JSON.stringify({ title: newTitle }),
          });

          if (!response.ok) {
            alert('Error updating chat title. Please try again.');
            return;
          }

          document.querySelector('h1').textContent = newTitle;
          document.getElementById('rename-form').close();
        } catch (error) {
          console.error('Error updating chat title:', error);
          alert('Error updating chat title. Please try again.');
        }
      },
    };
  }
</script>
